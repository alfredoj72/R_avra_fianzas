---
title: "5. ANÁLISIS DE OFERTA/DEMANDA Y CALIDAD EN LAS INSTALACIONES DEPORTIVAS DEL MUNICIPIO"
output: 
  officedown::rdocx_document:
    reference_docx: pandoc_template.docx    
    tables:
      style: Table
      layout: autofit
      width: 1.0
      caption:
       style: Table Caption
       pre: 'Tabla '
       sep: ': '
      conditional:
       first_row: true
       first_column: false
       last_row: false
       last_column: false
       no_hband: false
       no_vband: true
    plots:
      align: center
      caption:
       style: Image Caption
       pre: 'Figura '
       sep: ': '
params:
  municipioID:
    input: text
    label: "Identificador del municipio"
    value: "41032"
---

```{r, setup, include=FALSE}
library(tidyverse)
library(magrittr)
library(mschart)
library(flextable)
library(officer)
cod_provincia <- "41001"
municipioID <- params$municipioID %>%
  as.character()
demarcaciones <- informesDeportes::demarcaciones   #AMS Create package only whit data
demarcacion <- informesDeportes::demarcaciones %>%
  filter(cod_mun == municipioID) %>%
  pull("Demarcaciones Deportivas IECA")
PDIEDA <- informesDeportes::demarcaciones %>%
  filter(cod_mun == municipioID) %>%
  pull("Zona territorial PDIEDA")
lista_demarcaciones <- informesDeportes::demarcaciones %>%
  filter(`Demarcaciones Deportivas IECA` == demarcacion)%>%
  pull(cod_mun)
lista_PDIEDA<- informesDeportes::demarcaciones %>%
  filter(`Zona territorial PDIEDA` == PDIEDA)%>%
  pull(cod_mun)

municipioName <- informesDeportes::demarcaciones %>%
  filter(cod_mun == municipioID) %>%
  pull("nombre municipio")
to_int <- function(num){
  num %>%
    formatC(format = "f", digits = 0, big.mark = ".", decimal.mark = ",")
}
to_float <- function(num){
  num %>%
    formatC(format = "f", digits = 2, big.mark = ".", decimal.mark = ",")
}
to_porcentaje <- function(num){
  num %>%
    formatC(format = "f", digits = 2, big.mark = ".", decimal.mark = ",")
}

set_flextable_defaults(
  font.size = 10,
  border.color = "gray",
  padding.top = 3, padding.bottom = 3,
  padding.left = 4, padding.right = 4,
  text.align = "c",
  decimal.mark = ",",
  big.mark = ".")

knitr::opts_chunk$set(fig.align = 'center',
                      echo = FALSE,
                      warning = FALSE, 
                      message = FALSE,
                      dpi = 300)
separacion <- "\n"
```

**B) Infraestructura y oferta deportiva publico/privada del municipio**

**B.1. Introducción**

Para la elaboración del Plan Local de Instalaciones Deportivas del municipio de `r municipioName` y, en particular, para el análisis de la oferta de las instalaciones deportivas del municipio, se ha tomado como fuente el Inventario Andaluz de Instalaciones y Equipamientos Deportivos. Este Inventario se creó en el año 2000 (Decreto 284/2000 de 6 de junio de 2000, en vigor hasta el 20 de abril de 2022) y, actualmente, se encuentra regulado por el recientemente aprobado Decreto 48/2022, de 29 de marzo, que regula el Inventario Andaluz de Instalaciones y Equipamientos Deportivos y los Planes de Instalaciones y Equipamientos Deportivos de Andalucía.

El Inventario Andaluz de Instalaciones y Equipamientos Deportivos (IAIED) recoge todas las instalaciones deportivas, públicas y privadas, de uso colectivo, existentes en Andalucía, tiene un carácter permanente y su actualización y revisión, son continuas, a través de la información que incorporan los Ayuntamientos. El IAIED se configura como un instrumento censal, portador de una información necesaria y valiosa, al servicio de las funciones de programación de las Administraciones Públicas andaluzas en materia de instalaciones deportivas, muy especialmente, al servicio del Plan Director de Instalaciones Deportivas de Andalucía y de sus documentos de desarrollo. 

Según el Plan Director de Instalaciones y Equipamientos Deportivos de Andalucía (PDIEDA), se incluyen en el Inventario Andaluz aquellos espacios potenciales de práctica que cumplan los siguientes requisitos:

- Espacios convencionales o no, dotados de infraestructuras aptas para el ejercicio del deporte, en cualquiera de sus modalidades, así como los espacios complementarios y servicios auxiliares anejos imprescindibles para su funcionamiento, de acuerdo con los criterios establecidos en el Plan Director de Instalaciones y Equipamientos Deportivos de Andalucía.

- Se considera instalación deportiva aquella que se haya construido o realizado alguna actuación de adaptación para permitir la práctica físico-deportiva de manera permanente o que sea un lugar de general reconocimiento para el desarrollo de estas prácticas.


Teniendo en cuenta lo anterior, el presente análisis se centra en los espacios deportivos ubicados en instalaciones deportivas del municipio excluyendo los servicios complementarios y servicios auxiliares de estas instalaciones. 

En consonancia con el PDIEDA, y teniendo en cuenta la información disponible en el IAIED, para evaluar la oferta deportiva actual del municipio, se han analizado en el presente apartado los siguientes indicadores:

a) Tipo de gestión y titularidad de la propiedad (pública o privada).

b) Régimen de acceso de la dotación deportiva, permitiendo valorar la dotación efectiva o accesible a la población en general.

c) Antigüedad. Este indicador contribuye a valorar la dotación deportiva de un territorio en función de su antigüedad. Este indicador estaría relacionado con el nivel de inversiones destinadas a la modernización del parque deportivo existente. Tal como se establece en el PDIEDA, en el Inventario de los documentos de desarrollo del PDIEDA se clasificarán las instalaciones deportivas en tres grupos: Instalaciones deportivas construidas hasta el año 2000; Instalaciones deportivas construidas entre el año 2001 y el 2010 y; Instalaciones deportivas construidas desde el año 2011. 

d) Nivel de la dotación. El Plan Director establece tres niveles de dotación deportiva (la Red Básica, la Red Complementaria y la Red Especial). Determinadas características de las instalaciones deportivas generan que éstas pertenezcan a un nivel de dotación superior, con la consiguiente ampliación de su ámbito de influencia. En algunos casos es la propia naturaleza o singularidad de la instalación (un campo de béisbol, un puerto deportivo o una estación de esquí) la que aumenta su grado de atracción. En otros, son rasgos diferenciales de una instalación deportiva más común (el nivel de aforo de un pabellón o campo de fútbol, las dimensiones de una piscina, etc.), o su pertenencia a determinadas entidades (universidades, centros de alto rendimiento y de tecnificación deportiva, etc.). 

e) Grado de complejidad de las instalaciones deportivas, es otro de los indicadores contemplados en el PDIEDA, y viene dado por el número de espacios deportivos que acogen.
f) Calidad ambiental. El inventario debe ser una herramienta útil para la gestión y verificación de la calidad ambiental de las instalaciones deportivas que propugna la Ley 6/2016 del Deporte de Andalucía, y recoger datos suficientes que permitan realizar un seguimiento ambiental. Esta norma exige que las instalaciones deportivas deben atender a los requisitos medioambientales y de eficiencia energética, así como al medio donde se desarrolle la práctica deportiva (artículo 69.2). También exige el cumplimiento de los estándares medioambientales, de transporte y movilidad sostenible, y de eficiencia energética que deberán garantizar las normas técnicas sobre el diseño adecuado de las instalaciones (artículo 70.5).

g) Protección contra incendios.

h) Espacios deportivos según clase de espacio y según tipo de actividad deportiva principal practicada en el mismo, que permiten evaluar la diversidad del parque deportivo municipal, uso de los espacios y antigüedad de construcción y remodelación de los mismos.

Finalmente, se han analizado diversos indicadores compuestos como son:

<br>

i) Tasa de instalaciones deportivas. Número de habitantes entre el total de instalaciones deportivas del municipio.

j) Tasa de espacios deportivos. Número de habitantes entre el total de espacios deportivos del municipio.

k) Tasa de titularidad pública. Es un indicador que refleja el porcentaje de los espacios deportivos que son de titularidad pública.

<br>

**B.2. Inventario Local de Instalaciones deportivas de `r municipioName`**

```{r, include=FALSE, message=FALSE, warning=FALSE}
instalaciones <- informesDeportes::instalaciones %>%
  mutate(tipo_propiedad = as.factor(tipo_propiedad))%>%
  mutate(`situación` = `situación`%>%
           replace_na("No disponible")%>%
           as.factor())%>%
  mutate(`nivel_dotacion` = `nivel_dotacion`%>%
           replace_na("No disponible")%>%
           as.factor())%>%
  filter(nombre == municipioName) %>%
  distinct(New_CodigoIEDA, .keep_all = T)
espacios <- informesDeportes::espacios %>%
  mutate(clase_espacio_deportivo = as.factor(clase_espacio_deportivo))%>%
  filter(New_CodigoIEDA %in% instalaciones$New_CodigoIEDA)

num_instalaciones_colect_mun <- nrow(instalaciones)
espacios_deportivos <- sum(instalaciones$Número_Espacios_Dep)

```


Según los datos del Inventario Andaluz de Instalaciones y Equipamientos Deportivos, en el municipio de `r municipioName` se han censado `r `num_instalaciones_colect_mun` instalaciones de uso colectivo que cuentan con `r espacios_deportivos` espacios deportivos. Una instalación deportiva puede tener uno o varios espacios deportivos. Los espacios deportivos son los lugares de la instalación donde se lleva a cabo la práctica deportiva, y estos espacios deportivos se clasifican en espacios deportivos convencionales, singulares y áreas de actividad. 


```{r, echo=FALSE, dpi = 400, message=FALSE, warning=FALSE}
dibujar_grafico_sectores <- function(numbers, names, main_tittle = ""){
  vals <- numbers
  val_names <- sprintf("%s (%s)",
                       str_to_title(names),
                       scales::percent(round(vals/sum(vals), 2)))
  pie(vals , val_names,main = main_tittle, cex = 0.4)
}
```

La relación de Instalaciones Deportivas del municipio y sus correspondientes Espacios Deportivos, es la siguiente:

```{r, message=FALSE, warning=FALSE, echo=FALSE}
espacios_instalaciones_tbl <- espacios%>%
  mutate("Instalaciones deportivas"= nombreoficial)%>%
  group_by(`Instalaciones deportivas`)%>%
  summarise("Espacios convencionales" = grepl("CONVENCIONAL REGLADO",clase_espacio_deportivo)%>% sum(na.rm = T),
            "Espacios singulares" = grepl("CONVENCIONAL SINGULAR",clase_espacio_deportivo)%>% sum(na.rm = T),
            "Espacios no convencionales" = grepl("NO CONVENCIONAL-AREA DE ACTIVIDAD TERRESTRE",clase_espacio_deportivo)%>% sum(na.rm = T))
  
espacios_instalaciones_tbl <- espacios_instalaciones_tbl%>%
  mutate(Total = rowSums(select_if(., is.numeric))) 

espacios_instalaciones_tbl <- espacios_instalaciones_tbl%>%
  bind_rows(
    tibble::tibble(
  "Instalaciones deportivas" = "Total",
  "Espacios convencionales" = sum(espacios_instalaciones_tbl$`Espacios convencionales`),
  "Espacios singulares" = sum(espacios_instalaciones_tbl$`Espacios singulares`),
    "Espacios no convencionales" = sum(espacios_instalaciones_tbl$`Espacios no convencionales`),
  "Total" = sum(espacios_instalaciones_tbl$Total)
    )
  )


espacios_instalaciones_tbl <- espacios_instalaciones_tbl[, colSums(is.na(espacios_instalaciones_tbl)) == 0 ] %>%
  mutate(`Instalaciones deportivas` = `Instalaciones deportivas` %>%
           str_wrap(20))
colnames(espacios_instalaciones_tbl) <- colnames(espacios_instalaciones_tbl) %>%
  str_wrap(15)
espacios_instalaciones_tbl%>%
  flextable() %>%
  flextable::autofit()%>%
    align(align = "center", part = "body")%>%
  align(align = "left", j = 1)
```

Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

**B.3. Análisis de las instalaciones y los espacios deportivos de `r municipioName`**

```{r, include=FALSE}
reparto_pub_priv <- instalaciones %>%
  pull(tipo_propiedad)%>%
  fct_count()%>%
  arrange(-n)%>%
  mutate(perc = n /sum(n)*100,
         perc = to_porcentaje(perc))
frase_pub_priv <- glue::glue(
  'Así, mientras el {perc1}% es de {tipo1}, el {perc2}% es de {tipo2}.',
  perc1 = reparto_pub_priv$perc[[1]],
  perc2 = reparto_pub_priv$perc[[2]],
  tipo1 = tolower(reparto_pub_priv$f[[1]]),
  tipo2 = tolower(reparto_pub_priv$f[[2]]))
# 
# 
# frase_pub <- instalaciones_origen %>%
#   filter(tipo_propietario == "Pública")%>%
#   group_by(Propietario) %>%
#   summarise(n = n()) %>%
#   arrange(-n)%>%
#   mutate(perc = n /sum(n)*100,
#          perc = formatC(perc, decimal.mark = ",", big.mark = ".", format = "f", digits = 0),
#          frase = glue::glue(
#            'un {perc1}% las que son propiedad de la {prop1} y las {prop2} en segundo lugar, con un {perc2}%',
#            perc1 = perc[[1]],
#            perc2 = perc[[2]],
#            prop1 = tolower(Propietario[[1]]),
#            prop2 = tolower(Propietario[[2]])
#          )) %>%
#   pull(`frase`)
# frase_pub <- frase_pub[[1]]
# 
# 
# frase_priv <- instalaciones_origen %>%
#   filter(tipo_propietario == "Privada")%>%
#   group_by(Propietario) %>%
#   summarise(n = n()) %>%
#   arrange(-n)%>%
#   mutate(perc = n /sum(n)*100,
#          perc = formatC(perc, decimal.mark = ",", big.mark = ".", format = "f", digits = 0),
#          frase = glue::glue(
#            'un {perc1}% las que son propiedad de la {prop1} y las {prop2} en segundo lugar, con un {perc2}%',
#            perc1 = perc[[1]],
#            perc2 = perc[[2]],
#            prop1 = tolower(Propietario[[1]]),
#            prop2 = tolower(Propietario[[2]])
#          )) %>%
#   pull(`frase`)
# frase_priv <- frase_priv[[1]]
```


La distribución de las `r nrow(instalaciones)` instalaciones, atendiendo a su titularidad, pública o privada, se muestra en la siguiente figura. `r frase_pub_priv`. 
***Figura 1. Distribución de instalaciones deportivas según su titularidad***

```{r, echo=FALSE, dpi = 200, message=FALSE, warning=FALSE}
dibujar_grafico_sectores(
 reparto_pub_priv$n,
  reparto_pub_priv$f%>%
  str_to_title()
)
```

```{r, echo=FALSE, dpi = 400, message=FALSE, warning=FALSE}
instalaciones %>%
  mutate(Propietario = replace_na(Propietario, "Desconocido"),
         "Tipo de propiedad" = tipo_propiedad)%>%
  arrange(`Tipo de propiedad`) %>%
  ggplot(aes(x=Propietario, fill=`Tipo de propiedad` )) + 
  geom_bar() +
  scale_fill_brewer(palette = "Set1") +
  coord_flip()+
  ylab("Número de instalaciones")+
    facet_wrap(~`Tipo de propiedad`,ncol = 1)+
  scale_y_continuous(label = ~ scales::comma(.x, accuracy = 1))

```
```{r, message=FALSE, warning=FALSE, echo=FALSE}
perc_pub <- instalaciones %>%
  filter(tipo_gestion == "GESTION PUBLICA") %>%
  nrow()/nrow(instalaciones)*100 
perc_priv <- 100-perc_pub
perc_pub <- perc_pub %>%
  to_porcentaje()
perc_priv <- perc_priv%>%
  to_porcentaje()
```

Independientemente de la titularidad de las instalaciones, es importante conocer el tipo de gestión de las mismas (público y/o privado), ya que el gestor de la instalación no necesariamente es el mismo que el propietario. En el caso de `r municipioName`, un `r perc_pub`% de las instalaciones deportivas son de gestión pública, mientras que el `r perc_priv`% restante es de gestión privada.

***Figura 2. Distribución de instalaciones deportivos según tipo de gestión***
```{r, echo=FALSE, dpi = 400, message=FALSE, warning=FALSE}
dibujar_grafico_sectores(
 instalaciones %>%
  mutate(tipo_gestion = replace_na(tipo_gestion, "Desconocido"))%>%
  group_by(tipo_gestion) %>%
  summarise(n = n()) %>%
  pull(n),
  instalaciones %>%
  mutate(tipo_gestion = replace_na(tipo_gestion, "Desconocido"))%>%
  group_by(tipo_gestion) %>%
    summarise(n = n()) %>%
  pull(tipo_gestion)%>%
  str_to_title()
)
```

```{r, echo=FALSE, dpi = 400, message=FALSE, warning=FALSE}
instalaciones %>%
  mutate(tipo_gestion = replace_na(tipo_gestion, "No disponible"),
         "Tipo de gestión" = tipo_gestion)%>%
  mutate(Propietario = replace_na(Propietario, "No disponible"))%>%
  arrange(tipo_gestion) %>%
  ggplot(aes(x=Propietario, fill=`Tipo de gestión` )) + 
  geom_bar() +
  scale_fill_brewer(palette = "Set1") +
  coord_flip()+
  ylab("Número de instalaciones")+
  facet_wrap(~`Tipo de gestión`,ncol = 1)+
  scale_y_continuous(label = ~ scales::comma(.x, accuracy = 1))
```
```{r, include=FALSE, message=FALSE, warning=FALSE}
accesibilidad <- instalaciones %>%
  mutate(`Régimen de acceso` = `Régimen de acceso` %>%
           fct_collapse(
    "libre" = c("Libre gratuito", "Libre pagando cuota\n periódica de abono o socio", "Libre pagando entrada"),
    "restringido" = c("Restringido a\n residentes",
                      "Restringido a alumnos",
                      "Restringido a\n trabajadores\n o accionistas")
  ))%>%
  pull("Régimen de acceso")%>%
  fct_count()%>%
  arrange(f)%>%
  mutate(perc = n/sum(n)*100,
         perc = to_porcentaje(perc))
```

El **régimen de acceso** nos informa de cómo influye el tipo de titularidad y/o de gestión en el usuario, permitiendo valorar la accesibilidad a la instalación de la población en general. En el inventario pueden distinguirse seis categorías: Libre gratuito, Libre pagando entrada, Libre pagando cuota de abono o socio, Restringido a alumnos, Restringido a residentes y Restringido a trabajadores o accionistas. En el municipio de Alanís, un `r accesibilidad$perc[[2]]`% de las instalaciones son de acceso libre.

***Figura 3. Distribución de instalaciones deportivas según el régimen de acceso***

```{r, echo=FALSE, message=FALSE, warning=FALSE}
instalaciones %>%
  select(starts_with("Libre"))%>%
  bind_cols(instalaciones %>%
              select(starts_with("Restringido")))%>%
  pivot_longer(names_to = "Régimen de acceso",values_to = "Valor",cols = everything())%>%
  filter(Valor == "Si")%>%
  count(`Régimen de acceso`)%>%
  mutate("Porcentaje (%)" = n/sum(n)*100)%>%
  ggplot(aes(x=`Porcentaje (%)`, y=`Régimen de acceso`)) + 
    geom_col()+
    scale_x_continuous(label = ~ scales::comma(.x, accuracy = 1))
```
Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).
```{r, include=FALSE, message=FALSE, warning=FALSE}
antiguedad <- instalaciones %>%
  pull("antiguedad")%>%
  fct_count()%>%
  mutate(perc = n/sum(n)*100,
         perc = to_porcentaje(perc)) %>%
  arrange(f)
```

Si se analiza la antigüedad de las instalaciones deportivas, mientras el `r antiguedad$perc[[3]]`% de las mismas se construyeron antes del 2001, el `r antiguedad$perc[[2]]`% entre el año 2001 y el 2010 y, el `r antiguedad$perc[[1]]`% datan de fechas posteriores a 2010.

***Figura 4. Distribución de instalaciones deportivos según su antigüedad***

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dibujar_grafico_sectores(
  antiguedad$n,
  antiguedad$f%>%
  str_to_title()
)
```
Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

```{r, include=FALSE, message=FALSE, warning=FALSE}
ubicacion  <- instalaciones %>%
  pull("situación")%>%
  fct_count()%>%
  mutate(perc = n/sum(n)*100,
         perc = to_porcentaje(perc)) %>%
  arrange(-n)%>%
  filter(f != "No disponible")
```

La **situación territorial de la instalación**, puede informarnos sobre la proximidad de las mismas al núcleo urbano, donde suele concentrarse un mayor número de población, sobre el equilibrio territorial de las mismas y el valor añadido que representa su ubicación para la mejora de la estructura urbana en la que se inserta o para las estrategias socioeconómicas. En la siguiente figura puede observarse cómo en el municipio de `r municipioName` un `r ubicacion$perc[[1]]`% de las instalaciones se encuentran ubicadas en zona`r tolower(ubicacion$f[[1]])`, un `r ubicacion$perc[[2]]`% en zona `r tolower(ubicacion$f[[2]])` y, un `r ubicacion$perc[[3]]`% en zona `r tolower(ubicacion$f[[3]])`.

***Figura 5. Distribución de instalaciones deportivos según su situación territorial***

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dibujar_grafico_sectores(
  ubicacion$n,
  ubicacion$f%>%
  str_to_title()
)
```
Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

```{r, include=FALSE, message=FALSE, warning=FALSE}
dotacion  <- instalaciones %>%
 pull("nivel_dotacion")%>%
  fct_count()%>%
  mutate(perc = n/sum(n)*100,
         perc = to_porcentaje(perc)) %>%
  arrange(f)
```

Tal como se expone en el apartado introductorio, el Plan Director establece tres **niveles de dotación** de las instalaciones deportivas (la Red Básica, la Red Complementaria y la Red Especial). En el municipio de `r municipioName`, el `r dotacion$perc[[2]]`% de las instalaciones pertenecen a la Red Básica (es decir, equipamientos deportivos para la práctica deportiva generalizada, equipamientos escolares o universitarios), por su parte, el `r dotacion$perc[[3]]`% pertenece a la Red Complementaria (equipamientos deportivos con espacios de carácter convencional destinados a la competición a nivel provincial o que requieren espacios deportivos de características técnicas o dimensionales específicas) y, un `r dotacion$perc[[4]]`%, a la Red Especial (Equipamientos deportivos de accesibilidad restringida, de deporte de alto nivel o de competiciones de ámbito autonómico, nacional o incluso internacional).

***Figura 6. Distribución de instalaciones deportivos según su nivel de dotación***

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dibujar_grafico_sectores(
  dotacion%>%
  filter(n >0)%>%
    pull("n"),
  dotacion%>%
  filter(n >0)%>%
    pull("f")%>%
  str_to_title()
)
```
Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

```{r, include=FALSE, message=FALSE, warning=FALSE}
complejidad_pub <- instalaciones %>%
  filter(tipo_propiedad == "PROPIEDAD PUBLICA")%>%
  pull("complejidad")%>%
  fct_count()%>%
  mutate(perc = n/sum(n)*100,
         perc = to_porcentaje(perc)) %>%
  arrange(-n)

complejidad_priv <- instalaciones %>%
  filter(tipo_propiedad == "PROPIEDAD PRIVADA")%>%
  pull("complejidad")%>%
  fct_count()%>%
  mutate(perc = n/sum(n)*100,
         perc = to_porcentaje(perc)) %>%
  arrange(-n)
```


El **grado de complejidad** de las instalaciones deportivas es otros de los indicadores contemplados en el PDIEDA y viene dado por el número de espacios deportivos que acogen. Las instalaciones se han categorizado en tres tipos de instalación:

- Simple: con tan solo uno o dos espacios deportivos.

- Medio: con espacios de tres a seis.

- Complejas: con siete o más espacios.

Las instalaciones públicas son, mayoritariamente, `r tolower(complejidad_pub$f[[1]])`, alcanzando más de un `r complejidad_pub$perc[[1]]`%. Por su parte, las instalaciones privadas son, en su mayoría, `r tolower(complejidad_priv$f[[1]])`, con un `r complejidad_priv$perc[[1]]`%.

<br>

***Figura 7. Distribución de instalaciones deportivos según su grado de complejidad (cantidad de espacios deportivos)***

```{r, echo=FALSE, message=FALSE, warning=FALSE}
complejidad <- instalaciones%>%
  mutate("Grado de complejidad" = complejidad,
         "Tipo de propiedad" = tipo_propiedad)%>%
  group_by(`Grado de complejidad`,`Tipo de propiedad`)%>%
  summarise("Número de instalaciones" = n())%>%
  mutate(perc = `Número de instalaciones`/sum(`Número de instalaciones`)*100,
         perc = paste0(to_porcentaje(perc), "%")) %>%
  arrange(`Grado de complejidad`,`Tipo de propiedad`)
ggplot(complejidad, aes(fill=`Tipo de propiedad`, y=`Número de instalaciones`, x=`Grado de complejidad`)) + 
    geom_bar(position="dodge", stat="identity")+
    geom_text(aes(label = perc), vjust = -0.1)+
    scale_y_continuous(label = ~ scales::comma(.x, accuracy = 1))

```
Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

Para analizar la **calidad ambiental** de las instalaciones, se tienen en cuenta varios indicadores del inventario:

- Diseño bioclimático o ecoeficiente.

- Transporte y movilidad sostenible (disponibilidad de transporte colectivo público, servicio público de bicicletas o aparcamiento de bicicletas y aparcamiento de vehículos).

```{r, include=FALSE, message=FALSE, warning=FALSE}
perc_diseño_eficiencia <-instalaciones$diseno_eco%>%
  fct_count()%>%
  mutate(perc = n/sum(n)*100,
         perc = paste0(to_porcentaje(perc), "%")) %>%
  arrange(-n)
  
```

Los datos reflejan que ninguna instalación deportiva del municipio tiene diseño bioclimático o ecoeficiente.

***Figura 8. Cantidad de instalaciones deportivas según indicadores de calidad ambiental***

```{r, message=FALSE, warning=FALSE, echo=FALSE}
instalaciones %>%
  select(Bioclimático, Ecoeficiente)%>%
  pivot_longer(names_to = "Calidad ambiental",values_to = "Valor",cols = everything())%>%
  count(`Calidad ambiental`, Valor)%>%
  group_by(`Calidad ambiental`)%>%
  summarise("Porcentaje (%)" =n/sum(n)*100,
            Valor = Valor)%>%
  ggplot(aes(fill=Valor, x=`Porcentaje (%)`, y=`Calidad ambiental`)) + 
    geom_col()+
    scale_x_continuous(label = ~ scales::comma(.x, accuracy = 1))
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
perc_trans <- instalaciones %>%
  select(`Aparcamiento (propio o en las inmediaciones)`,
          `Aparcamiento de bicicletas`,
         `Servicio público de bicicletas`,
         `Transporte colectivo (estación o parada de transporte colectivo en las inmediaciones de la instalación)`)%>%
  unite("valor")%>%
  mutate(valor = ifelse(grepl("Si", valor), 1, 0))%>%
  pull("valor")
perc_trans <-  sum(perc_trans)/length(perc_trans)*100
perc_trans <- perc_trans %>%
  to_porcentaje()
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
transporte <- instalaciones %>%
  select(`Aparcamiento (propio o en las inmediaciones)`,
          `Aparcamiento de bicicletas`,
         `Servicio público de bicicletas`,
         `Transporte colectivo (estación o parada de transporte colectivo en las inmediaciones de la instalación)`)
colnames(transporte) <- colnames(transporte)%>%
  str_wrap(20)

transporte%>%
  pivot_longer(names_to = "Transporte",values_to = "Valor",cols = everything())%>%
  count(Transporte, Valor)%>%
  group_by(Transporte)%>%
  summarise("Porcentaje (%)" =n/sum(n)*100,
            Valor = Valor)%>%
  ggplot(aes(fill=Valor, x=`Porcentaje (%)`, y=`Transporte`)) + 
    geom_col()+
    scale_x_continuous(label = ~ scales::comma(.x, accuracy = 1))

```
Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).


En relación al transporte y movilidad sostenible, un `r perc_trans`% de las instalaciones deportivas dispone de algún tipo de servicio o equipamiento de este tipo: aparcamiento de bicicletas, servicio público de bicicletas, aparcamiento (propio o en las instalaciones) y/o transporte colectivo (estación o parada cerca de la instalación).


```{r, include=FALSE, message=FALSE, warning=FALSE}
incendios <-instalaciones%>%
  select(`Extintores portátiles`,
         `Alumbrado de emergencia`,
         `Bocas de incendios equipadas`)%>%
  pivot_longer(names_to = "Equipamiento",values_to = "Valor",cols = everything())%>%
  filter(Valor == "Si")%>%
  count(Equipamiento) %>%
  arrange(-n)%>%
  mutate(perc2 = n /nrow(instalaciones)*100,
         perc = perc2%>% to_porcentaje())
  
```


En cuanto al cumplimiento de la normativa de **Protección contra incendios**, las instalaciones deportivas del municipio de `r municipioName`, cuentan con `r tolower(incendios$Equipamiento[[1]])` en un `r incendios$perc[[1]]`% de los casos, con `r tolower(incendios$Equipamiento[[2]])` en un `r incendios$perc[[2]]`% de los casos y con `r tolower(incendios$Equipamiento[[3]])` en un `r incendios$perc[[3]]`%.

***Figura 9. Cantidad de instalaciones deportivas que disponen de sistemas de protección contra incendios***

```{r, echo=FALSE, message=FALSE, warning=FALSE}
incendios%>%
  mutate("Porcentaje (%)" = perc2)%>%
  ggplot(aes(x=`Porcentaje (%)`, y=`Equipamiento`)) + 
    geom_col()+
    scale_x_continuous(label = ~ scales::comma(.x, accuracy = 1))

```

Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

Tras analizar el conjunto de `r num_instalaciones_colect_mun` instalaciones deportivas del municipio de `r municipioName` y sus características, a continuación se analizan los `r espacios_deportivos` espacios deportivos que se encuentran en dichas instalaciones, según clases de espacios, actividad principal, estado de uso y año de construcción y remodelación.

```{r, message=FALSE, warning=FALSE, echo=FALSE}
clases_espacios <- espacios$clase_espacio_deportivo%>%
  fct_count()%>%
  mutate(perc = n / sum(n)*100)
reglado <-clases_espacios %>%
  filter(grepl("REGLADO", f))%>%
  pull("perc")%>%
  to_porcentaje()

singulares <-clases_espacios %>%
  filter(grepl("SINGULAR", f))%>%
  pull("perc")%>%
  to_porcentaje()

no_convencional <-clases_espacios %>%
  filter(grepl("NO CONVENCIONAL", f))%>%
  pull(n)%>%
  sum()/sum(clases_espacios$n)*100
no_convencional <- no_convencional%>%
  to_porcentaje()
```


En cuanto a las **clases de espacios**, un `r reglado`% son espacios convencionales reglados, un `r singulares`% son espacios convencionales singulares y, un `r no_convencional`% se localizan en áreas de actividad (terrestre, aérea y/o acuática).

***Figura 10. Distribución de los espacios deportivos según su clase y tipología***

```{r, message=FALSE, warning=FALSE, echo=FALSE}
dibujar_grafico_sectores(
  clases_espacios%>%
  filter(n >0)%>%
    pull("n"),
  clases_espacios%>%
  filter(n >0)%>%
    pull("f")%>%
  str_to_title()
)
```


Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

```{r, message=FALSE, warning=FALSE, echo=FALSE}
espacios %>%
  mutate(descripcion = as.factor(descripcion))%>%
  group_by(clase_espacio_deportivo, descripcion)%>%
  summarise(n = n()) %>%
  ungroup()%>%
  group_by(clase_espacio_deportivo)%>%
  mutate("Porcentaje (%)" = n/sum(n)*100)%>%
  mutate("Clases de espacios deportivos" = str_wrap(clase_espacio_deportivo , 20),
         "Descripción" = str_wrap(descripcion , 20))%>%
  ggplot(aes(x=`Porcentaje (%)`, y=`Descripción`, fill = `Clases de espacios deportivos`)) + 
    geom_col()+
    scale_x_continuous(label = ~ scales::comma(.x, accuracy = 1))+
  facet_wrap(~`Clases de espacios deportivos`,scales = "free_y")
```
A continuación se analizan los espacios deportivos según la actividad principal practicada. Así, en la siguiente tabla se exponen las actividades principales más frecuentes realizadas en los `r espacios_deportivos` espacios deportivos de `r municipioName`.

*Listado de actividades principales más frecuentes practicadas en los espacios deportivos*

```{r, message=FALSE, warning=FALSE, echo=FALSE}
espacios$descripcion_2 %>%
  as.factor()%>%
  fct_count()%>%
  arrange(-n)%>%
  mutate("Nº de espacios" = n,
         "Actividades principales más frecuentes" = str_wrap(f, 20))%>%
  select(`Nº de espacios`, `Actividades principales más frecuentes`)%>%
  flextable() %>%
  flextable::autofit()%>%
    align(align = "center", part = "body")
```

Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).

***Figura 11. Distribución de los espacios deportivos según su estado de uso***

```{r}
uso_esp <- espacios$descripcion_4 %>%
  fct_collapse("EN USO" = c("Estacional", "Normal"),
               "FUERA DE USO" = c("En construcción",
                                  "En remodelación",
                                  "Fuera de uso"))%>%
  fct_count() %>%
  mutate(perc = n/sum(n)*100)%>%
  arrange(f)

dibujar_grafico_sectores(
  uso_esp%>%
    pull("n"),
  uso_esp%>%
    pull("f")%>%
  str_to_title()
)
```

Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022).


En relación al **estado de uso** de los espacios deportivos, el `r to_porcentaje(uso_esp$perc[[2]])`% de éstos se encuentran en uso (ya sea uso normal o estacional), mientras que un `r to_porcentaje(uso_esp$perc[[1]])`% se trata de espacios que están fuera de uso (porque se encuentran en construcción, en remodelación o simplemente porque no se usan).   

```{r, include=FALSE}
IECA_mun <- informesDeportes::fichas_municipales_IECA %>%
  filter(CodMun == municipioID)
pob <- to_int(IECA_mun$`Población total. 2021`)
```
Finalmente, se analiza el número de habitantes por instalación y por espacio deportivo, así como el porcentaje de espacios deportivos que son públicos sobre el total de espacios. Los datos estadísticos necesarios para la construcción de estos últimos indicadores compuestos se obtienen, por un lado, del IAIED (`r num_instalaciones_colect_mun` instalaciones deportivas y `r espacios_deportivos` espacios deportivos) y, por otro, de la población censada en Alanís correspondiente a enero de 2021 (`r pob` hab.).

```{r, echo=FALSE, message=FALSE, warning=FALSE}
hab_tbl <-to_int(IECA_mun$`Población total. 2021`)
inst_tbl <-to_int(num_instalaciones_colect_mun)
esp_tbl <-to_int(espacios_deportivos)
esp_pub_tbl <- instalaciones%>%
  filter(tipo_propiedad == "PROPIEDAD PUBLICA")%>%
  pull("Número_Espacios_Dep")%>%
  sum()

tibble(
  "Indicador" = c("Tasa de instalaciones deportivas",
                  "Tasa de espacios deportivos",
                  "Tasa titularidad pública"),
  "Expresión" = c(
    glue::glue(
    'Nº habitantes ({hab_tbl}) / Nº de instalaciones ({inst_tbl})*1.000'),
    glue::glue(
    'Nº habitantes ({hab_tbl}) / Nº de espacios ({esp_tbl}*1.000)'    
  ),
  glue::glue(
    'Nº espacios públicos ({esp_pub_tbl}) / Nº de espacios ({esp_tbl})')
  ),
"Resultado" = c(
  to_float(IECA_mun$`Población total. 2021`/num_instalaciones_colect_mun*1000),
  to_float(IECA_mun$`Población total. 2021`/espacios_deportivos*1000),
  to_float(esp_pub_tbl/espacios_deportivos
)))%>%
  mutate_all(str_wrap)%>%
  flextable() %>%
  flextable::autofit()%>%
    align(align = "center", part = "body")
```
Fuente: Inventario Andaluz de Instalaciones y Equipamientos Deportivos (junio de 2022) y Padrón Municipal de Habitantes 2021. Instituto de Estadística y Cartografía de Andalucía.

**C) Geolocalización de las instalaciones y espacios deportivos del municipio ajustado al Inventario Andaluz de Instalaciones y Equipamientos Deportivos de Andalucía (IAIEDA)**

Tal como establece el PDIEDA, los planes locales de instalaciones deportivas deben contener un Inventario Local de Instalaciones Deportivas que analice, además, la localización territorial de las mismas. 

Por tanto, en el presente apartado se expone, en primer lugar, un mapa de la distribución territorial del conjunto de las Instalaciones y Espacios Deportivos del municipio y, a continuación, se expone una ficha descriptiva para cada una de las instalaciones, con datos sobre su geolocalización e información significativa, tanto de la instalación como de sus espacios deportivos.

**C.1. Oferta deportiva del municipio de `r municipioName`**

Para el análisis territorial se ha desarrollado una metodología basada en la utilización de herramientas SIG que permiten visualizar territorialmente la oferta de instalaciones deportivas del municipio de `r municipioName` con la información disponible en el IAIED.

**Mapa 1. Distribución territorial de la oferta deportiva: Instalaciones y Espacios Deportivos del municipio de `r municipioName`**

**C.2. Localización de cada una de las instalaciones y espacios deportivos**

A continuación se ofrece una ficha descriptiva para cada una de las instalaciones deportivas del municipio que contiene 4 bloques de información:

- Datos identificativos.
- Mapa con la localización de la instalación.
- Características de la instalación.
- Características de cada espacio deportivo que se ubica en la instalación.

XXX

**D) Accesibilidad de la población y eliminación de barreras arquitectónicas a las instalaciones deportivas**

**D.1. Áreas de influencia**

El cálculo de cada área de influencia se ha determinado en función de lo establecido en el PDIEDA para los espacios deportivos que integran la red básica, ya que son los espacios los que determinan la actividad a realizar y éstas, a su vez, las que determinan el área de influencia.

Efectivamente, no tendrán igual amplitud actividades que tengan mayor poder de atracción, tanto por motivaciones intrínsecas como extrínsecas, como otras menos demandadas. Los espacios con mayor área de influencia son las piscinas cubiertas y las pistas de atletismo. Además, se debe tener en cuenta que Alanís está dentro la tipología Áreas Rurales.

XXX

Por tanto, para calcular el área de influencia se utiliza una cobertura que, colocando el centro del mismo en la ubicación de la instalación deportiva, nos permita ver de forma muy rápida el área de influencia y, por lo tanto, los núcleos poblaciones a satisfacer.
En los mapas de las siguientes páginas se muestran el área de influencia de los espacios deportivos que integran la red básica:

- Pabellones.
- Salas.
- Pistas de tenis.
- Pistas de pádel.
- Pistas polideportivas.
- Pista de atletismo.
- Piscinas aire libre.
- Piscinas cubiertas.
- Fútbol.

**Mapa de área de influencia de salas multifuncionales (8 km)**

**D.2. Población cubierta**

En cada área de influencia calculada anteriormente, y gracias al uso de SIG, es posible la determinación de datos poblaciones por cada una de los espacios deportivos, así como el total por la tipología de estos espacios, teniendo en cuenta en el cálculo de la cobertura, las variables sexo y edad. 
Por tanto, en primer lugar, en la siguiente tabla se muestra la población cubierta según el tipo de espacio deportivo de la red básica.

XXX

Por su parte, a continuación se expone la misma información para cada uno de los espacios deportivos de las instalaciones deportivas del municipio de `municipioName`.

**D.3. Adaptación de las instalaciones deportivas a personas con movilidad reducida**

Uno de los objetivos del PDIEDA es *“El aumento de la calidad de vida, el bienestar social y el desarrollo integral saludable de la ciudadanía de Andalucía, a través de la mejora de las instalaciones deportivas, del equipamiento deportivo y de su accesibilidad y movilidad y de su respeto al medio ambiente”. Para su cumplimiento, el Plan Director establece que la planificación de las instalaciones deportivas se realizará de acuerdo con una serie de criterios de actuación, entre los que se destaca “e) La integración social en términos de accesibilidad”*.

A tal efecto y con el fin de analizar el cumplimiento de los estándares de accesibilidad para las personas con movilidad reducida, a continuación se exponen los datos extraídos del IAIED de las instalaciones del municipio de `r municipioName`, con respecto a dos indicadores de accesibilidad.

- La instalación ha sido concebida como adaptada
- La instalación se ha adaptado mediante reformas

XXX

A continuación se expone la relación de instalaciones al objeto de identificar las instalaciones específicas con posibles necesidades de adaptación.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
adapt_inst <- instalaciones %>%
  mutate("Instalaciones deportivas" = nombreoficial)%>%
  select(`Instalaciones deportivas`,
         `Instalación concebida como adaptada`,
         `Instalación se ha adaptado mediente reformas`)%>%
  mutate(`Instalaciones deportivas` = `Instalaciones deportivas` %>%
           str_wrap(20),
         `Instalación concebida como adaptada` = `Instalación concebida como adaptada` %>%
           str_replace("Si", "✔"),
         `Instalación se ha adaptado mediente reformas` = `Instalación se ha adaptado mediente reformas` %>%
           str_replace("Si", "✔"),
                  `Instalación concebida como adaptada` = `Instalación concebida como adaptada` %>%
           str_replace("No", "❌"),
         `Instalación se ha adaptado mediente reformas` = `Instalación se ha adaptado mediente reformas` %>%
           str_replace("No", "❌"))
colnames(adapt_inst) <- colnames(adapt_inst) %>% str_wrap(20)
adapt_inst%>%
  flextable() %>%
  flextable::autofit()
```
**E) Déficit actual y futuro en la oferta de instalaciones deportivas en el municipio**

Siguiendo el capítulo dedicado a la provincia de Sevilla del documento PDIEDA, se establece que `r municipioName` pertenece a `r PDIEDA`, de Sevilla. Esta zona territorial engloba a `r length(lista_PDIEDA)` municipios catalogados como Áreas rurales, siguiendo la jerarquía del Sistema de Ciudades definido por el Plan de Ordenación del Territorio de
Andalucía.

```{r, include=FALSE}
delta_pob_censo <- informesDeportes::evolucion_poblacion_sevilla %>%
  filter(Anual %in% c(2004, 2016) & Edad == "TOTAL" & `Grupo por sexo` == "Ambos sexos")%>%
  filter(`Cod INE` == as.numeric(municipioID)) %>%
  pull(Valor)%>%
  as.numeric()%>%
  diff()
calificativo_censo <- ifelse(delta_pob_censo >0, "aumentado", "disminuido")

densidad_IECA <-informesDeportes::fichas_municipales_IECA %>%
  filter(CodMun %in% lista_PDIEDA)%$%
  {sum(`Población total. 2021`)/sum(`Extensión superficial (Km2). 2019`)}

sacar_porcentaje <- function(lista_num){
  a <- lista_num[[1]]
  b <- lista_num[[2]]
  (b-a)/b*100
}
tasa_crec_IECA <- informesDeportes::evolucion_poblacion_sevilla %>%
  filter(`Cod INE` %in% lista_PDIEDA)%>%
  filter(Anual %in% c(2004, 2016) & Edad == "TOTAL" & `Grupo por sexo` == "Ambos sexos")%>%
  group_by(Anual)%>%
  summarise(SumaPob = sum(as.numeric(Valor)))%>%
  pull(SumaPob)%>%
  sacar_porcentaje()%>%
  to_porcentaje()

```

El conjunto de la población de esta zona territorial, ha `r calificativo_censo` en `r to_int(delta_pob_censo)` habitantes
en el período censal 2004-2016. La SE-2 tiene una tasa de crecimiento del `r tasa_crec_IECA`% y una
densidad de `r to_float(densidad_IECA)` habitantes por kilómetro cuadrado.

En las tablas siguientes se exponen las ratios (necesidades de instalaciones deportivas
por habitante) en cada uno de los espacios deportivos y en base a la clasificación de
zonas PDIEDA, de acuerdo con las Normas NIDE para las Zonas Rurales.

XXX

Aplicando dichos parámetros se puede calcular el número de espacios deportivos que en la actualidad serían necesarios y plasmándose de esa manera el déficit de espacios deportivos teniendo en cuenta la población actual, y la población futura para los próximos 5 años calculada a partir de las proyecciones municipales y por demarcación deportiva del Instituto de Estadística y Cartografía de Andalucía (IECA).

**E.1. Déficit actual en la oferta de instalaciones deportivas del municipio de `r municipioName`**

Para el cálculo del déficit actual en la oferta de instalaciones deportivas del municipio de `r municipioName`, se utilizarán los espacios deportivos convencionales de la red básica censados en el Inventario, considerando únicamente como válidos para esta comparación los espacios deportivos de acceso no restringido (ver siguiente tabla).

XXX

Por tanto, teniendo en cuenta los datos anteriores y tomando como referencia los ratios establecidos por el PDIEDA, así como la población del año 2021 (momento en el
que `r municipioName` contaba con `r pob` habitantes), a continuación se presenta el análisis del déficit según las tipologías de espacios.

XXX

